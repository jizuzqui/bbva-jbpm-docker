FROM jboss/jbpm-server-full:latest

LABEL maintainer="jaime.izuzquiza@bbva.com"

ENV MAVEN_REPO_PASSWORD="AKCp5aTGk1yg22DimQvqRNEVaxqXvvYbCy77hzTAQkGrnTKakJ7sxTshBrnAgycDSYNp5UUad"
ENV MAVEN_REPO_URL="https://artifact-cache-level1-work-es.ether.iaas.igrupobbva/artifactory/mvn-bpm-work-es/"

ENV JBOSS_CONFIG=standalone-full.xml
ENV JBOSS_MODE=standalone

ENV MAVEN_REPO_PASSWORD="AKCp5aTGk1yg22DimQvqRNEVaxqXvvYbCy77hzTAQkGrnTKakJ7sxTshBrnAgycDSYNp5UUad"
ENV MAVEN_REPO_URL="https://artifact-cache-level1-work-es.ether.iaas.igrupobbva/artifactory/mvn-bpm-work-es/"

COPY ./add-datasource.sh $JBOSS_HOME
COPY ./datasources.cli $JBOSS_HOME

USER root
RUN chmod 755 $JBOSS_HOME/add-datasource.sh
RUN chown jboss:root $JBOSS_HOME/add-datasource.sh

# Switch to jboss user
USER jboss

#COPY ./templates/maven-settings.xml $HOME/.m2/settings.xml

# COPY etc/META-INF/kie-deployment-descriptor.xml $JBOSS_HOME/standalone/deployments/kie-execution-server.war/WEB-INF/classes/META-INF/kie-deployment-descriptor.xml
# COPY ./jboss-deployment-structure.xml $JBOSS_HOME/standalone/deployments/kie-execution-server.war/WEB-INF/

RUN $JBOSS_HOME/bin/add-user.sh -a -u controllerUser -p controllerUser1234 -g kie-server,rest-all

ENV EXTRA_OPTS="$EXTRA_OPTS)
	-Dorg.kie.server.id=jbpm-development-server )
	-Dorg.kie.server.location=http://localhost:8080/kie-server/services/rest/server )
	-Dorg.kie.server.controller=http://localhost:8080/business-central/rest/controller )
	-Dorg.kie.server.controller.user=controllerUser )
	-Dorg.kie.server.controller.pwd=password@1 )
	-Dorg.kie.server.user=controllerUser)
	-Dorg.kie.server.pwd=password@1)
	-Dorg.jbpm.task.cleanup.enabled=false)
	-Dappformer.experimental.features=true)
	-Dorg.kie.prometheus.server.ext.disabled=true)
	-Dorg.kie.server.persistence.ds=java:jboss/datasources/jBPMDS"
		
		
		
		
		
		
		/core-service=management/security-realm=ApplicationRealm/authentication=properties:read-attribute(name=path)

/system-property=org.kie.server.id:add(value=jbpm-development-server)
/system-property=org.kie.server.location:add(value=http://localhost:8080/kie-server/services/rest/server)
/system-property=org.kie.server.controller:add(value=http://localhost:8080/business-central/rest/controller)
/system-property=org.kie.server.controller.user:add(value=controllerUser)
/system-property=org.kie.server.controller.pwd:add(value=password@1 )
/system-property=org.kie.server.user:add(value=controllerUser)
/system-property=org.kie.server.pwd:add(value=password@1)
/system-property=org.jbpm.task.cleanup.enabled:add(value=false)
/system-property=appformer.experimental.features:add(value=true)
/system-property=org.kie.prometheus.server.ext.disabled:add(value=true)
/system-property=org.kie.server.persistence.ds:add(value=java:jboss/datasources/jBPMDS)

/system-property=org.kie.server.controller:remove()
/system-property=org.jbpm.casemgmt.showcase.url:remove()
/system-property=org.jbpm.ht.admin.group:remove()
/system-property=org.jbpm.task.cleanup.enabled:remove()
/system-property=org.kie.server.persistence.ds:remove()
/system-property=appformer.experimental.features:remove()
/system-property=org.kie.prometheus.server.ext.disabled:remove()
/system-property=kie.keystore.keyStoreURL:remove()
/system-property=kie.keystore.keyStorePwd:remove()
/system-property=kie.keystore.key.server.alias:remove()
/system-property=kie.keystore.key.server.pwd:remove()
/system-property=kie.keystore.key.ctrl.alias:remove()
/system-property=kie.keystore.key.ctrl.pwd:remove()
/system-property=org.kie:remove()









############## Timer service
        <subsystem xmlns="urn:jboss:domain:ejb3:5.0">
            <session-bean>
                <stateless>
                    <bean-instance-pool-ref pool-name="slsb-strict-max-pool"/>
                </stateless>
                <stateful default-access-timeout="5000" cache-ref="simple" passivation-disabled-cache-ref="simple"/>
                <singleton default-access-timeout="5000"/>
            </session-bean>
            <mdb>
                <resource-adapter-ref resource-adapter-name="${ejb.resource-adapter-name:activemq-ra.rar}"/>
                <bean-instance-pool-ref pool-name="mdb-strict-max-pool"/>
            </mdb>
            <pools>
                <bean-instance-pools>
                    <strict-max-pool name="mdb-strict-max-pool" derive-size="from-cpu-count" instance-acquisition-timeout="5" instance-acquisition-timeout-unit="MINUTES"/>
                    <strict-max-pool name="slsb-strict-max-pool" derive-size="from-worker-pools" instance-acquisition-timeout="5" instance-acquisition-timeout-unit="MINUTES"/>
                </bean-instance-pools>
            </pools>
            <caches>
                <cache name="simple"/>
                <cache name="distributable" passivation-store-ref="infinispan" aliases="passivating clustered"/>
            </caches>
            <passivation-stores>
                <passivation-store name="infinispan" cache-container="ejb" max-size="10000"/>
            </passivation-stores>
            <async thread-pool-name="default"/>
            <timer-service thread-pool-name="default" default-data-store="ejb_timer_ds">
                <data-stores>
                    <file-data-store name="default-file-store" path="timer-service-data" relative-to="jboss.server.data.dir"/>
                    <database-data-store name="ejb_timer_ds" datasource-jndi-name="java:jboss/datasources/EjbTimerDS" database="postgresql" partition="ejb_timer_part" allow-execution="true"/>
                </data-stores>
            </timer-service>
            <remote connector-ref="http-remoting-connector" thread-pool-name="default">
                <channel-creation-options>
                    <option name="READ_TIMEOUT" value="${prop.remoting-connector.read.timeout:20}" type="xnio"/>
                    <option name="MAX_OUTBOUND_MESSAGES" value="1234" type="remoting"/>
                </channel-creation-options>
            </remote>
            <thread-pools>
                <thread-pool name="default">
                    <max-threads count="10"/>
                    <keepalive-time time="100" unit="milliseconds"/>
                </thread-pool>
            </thread-pools>
            <iiop enable-by-default="false" use-qualified-name="false"/>
            <default-security-domain value="other"/>
            <default-missing-method-permissions-deny-access value="true"/>
            <log-system-exceptions value="true"/>
        </subsystem>


########## Datasources
 
 H2
 <datasources>
                <datasource jndi-name="java:jboss/datasources/XjBPMDS" pool-name="jBPMDS" enabled="true" use-java-context="true">
                    <connection-url>jdbc:jdbc:h2:file:${jboss.server.data.dir}/jbpm-db;MVCC=TRUE</connection-url>
                    <driver>h2</driver>
                    <pool>
                        <max-pool-size>25</max-pool-size>
                    </pool>
                    <security>
                        <user-name>sa</user-name>
                        <password>sa</password>
                    </security>
                    <timeout>
                        <blocking-timeout-millis>5000</blocking-timeout-millis>
                    </timeout
                </datasource>
                <xa-datasource jndi-name="java:jboss/datasources/jBPMDS" pool-name="jBPMXADS" enabled="true">
                    <xa-datasource-property name="URL">
                        jdbc:h2:file:${jboss.server.data.dir}/jbpm-db;MVCC=TRUE
                    </xa-datasource-property>
                    <xa-datasource-class>org.h2.jdbcx.JdbcDataSource</xa-datasource-class>
                    <driver>h2</driver>
                    <security>
                        <user-name>sa</user-name>
                        <password>sa</password>
                    </security>
                </xa-datasource>
                <drivers>
                    <driver name="h2" module="com.h2database.h2">
                        <xa-datasource-class>org.h2.jdbcx.JdbcDataSource</xa-datasource-class>
                    </driver>
                </drivers>
            </datasources>
			
Postgresql
        <subsystem xmlns="urn:jboss:domain:datasources:5.0">
            <datasources>
                <datasource jndi-name="java:jboss/datasources/ExampleDS" pool-name="ExampleDS" enabled="true" use-java-context="true">
                    <connection-url>jdbc:h2:mem:test;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE</connection-url>
                    <driver>h2</driver>
                    <security>
                        <user-name>sa</user-name>
                        <password>sa</password>
                    </security>
                </datasource>
                <xa-datasource jndi-name="java:jboss/datasources/PostgresqlKIE" pool-name="PostgresqlKIE" enabled="true" use-java-context="true" spy="false" use-ccm="true" tracking="false" enlistment-trace="false" statistics-enabled="true">
                    <xa-datasource-property name="DatabaseName">
                        ${env.PSTQL_DB_NAME}
                    </xa-datasource-property>
                    <xa-datasource-property name="PortNumber">
                        ${env.PSTQL_DB_PORT}
                    </xa-datasource-property>
                    <xa-datasource-property name="ServerName">
                        ${env.PSTQL_DB_HOST}
                    </xa-datasource-property>
                    <driver>postgresql</driver>
                    <transaction-isolation>TRANSACTION_READ_COMMITTED</transaction-isolation>
                    <xa-pool>
                        <min-pool-size>${env.KIE_MIN_POOL}</min-pool-size>
                        <initial-pool-size>${env.KIE_INITIAL_POOL}</initial-pool-size>
                        <max-pool-size>${env.KIE_MAX_POOL}</max-pool-size>
                        <prefill>false</prefill>
                        <fair>true</fair>
                        <use-strict-min>true</use-strict-min>
                        <flush-strategy>FailingConnectionOnly</flush-strategy>
                        <allow-multiple-users>false</allow-multiple-users>
                        <is-same-rm-override>false</is-same-rm-override>
                        <pad-xid>false</pad-xid>
                        <wrap-xa-resource>true</wrap-xa-resource>
                    </xa-pool>
                    <security>
                        <user-name>${env.PSTQL_DB_USERNAME}</user-name>
                        <password>${env.PSTQL_DB_PASSWORD}</password>
                    </security>
                    <timeout>
                        <set-tx-query-timeout>true</set-tx-query-timeout>
                        <blocking-timeout-millis>5000</blocking-timeout-millis>
                        <idle-timeout-minutes>10</idle-timeout-minutes>
                        <query-timeout>5</query-timeout>
                        <allocation-retry>3</allocation-retry>
                        <allocation-retry-wait-millis>3000</allocation-retry-wait-millis>
                        <xa-resource-timeout>30</xa-resource-timeout>
                    </timeout>
                    <statement>
                        <track-statements>False</track-statements>
                        <prepared-statement-cache-size>100</prepared-statement-cache-size>
                        <share-prepared-statements>false</share-prepared-statements>
                    </statement>
                </xa-datasource>
				
				
				xa-data-source add --name="EjbTimerDS" --jndi-name=java:jboss/datasources/EjbTimerDS --enabled=true --driver-name=h2 --use-java-context=true --spy=false --use-ccm=true --tracking=false --enlistment-trace=false --statistics-enabled=true --transaction-isolation=TRANSACTION_READ_COMMITTED --user-name=sa --password=sa --xa-datasource-properties=[{URL=jdbc:h2:file:${jboss.server.data.dir}/jbpm-db;MVCC=TRUE}]
				
				
                <xa-datasource jndi-name="java:jboss/datasources/EjbTimerDS" pool-name="EjbTimerDS" enabled="true" use-java-context="true" spy="false" use-ccm="true" tracking="false" enlistment-trace="false" statistics-enabled="true">
                    <xa-datasource-property name="DatabaseName">
                        ${env.PSTQL_DB_NAME_EJBTIMER}
                    </xa-datasource-property>
                    <xa-datasource-property name="PortNumber">
                        ${env.PSTQL_DB_PORT_EJBTIMER}
                    </xa-datasource-property>
                    <xa-datasource-property name="ServerName">
                        ${env.PSTQL_DB_HOST_EJBTIMER}
                    </xa-datasource-property>
                    <driver>postgresql</driver>
                    <transaction-isolation>TRANSACTION_READ_COMMITTED</transaction-isolation>
                    <xa-pool>
                        <min-pool-size>${env.EJBTIMER_MIN_POOL}</min-pool-size>
                        <initial-pool-size>${env.EJBTIMER_INITIAL_POOL}</initial-pool-size>
                        <max-pool-size>${env.EJBTIMER_MAX_POOL}</max-pool-size>
                        <prefill>false</prefill>
                        <fair>true</fair>
                        <use-strict-min>true</use-strict-min>
                        <flush-strategy>FailingConnectionOnly</flush-strategy>
                        <allow-multiple-users>false</allow-multiple-users>
                        <is-same-rm-override>false</is-same-rm-override>
                        <pad-xid>false</pad-xid>
                        <wrap-xa-resource>true</wrap-xa-resource>
                    </xa-pool>
                    <security>
                        <user-name>${env.PSTQL_DB_USERNAME_EJBTIMER}</user-name>
                        <password>${env.PSTQL_DB_PASSWORD_EJBTIMER}</password>
                    </security>
                    <timeout>
                        <set-tx-query-timeout>true</set-tx-query-timeout>
                        <blocking-timeout-millis>5000</blocking-timeout-millis>
                        <idle-timeout-minutes>10</idle-timeout-minutes>
                        <query-timeout>5</query-timeout>
                        <allocation-retry>3</allocation-retry>
                        <allocation-retry-wait-millis>3000</allocation-retry-wait-millis>
                        <xa-resource-timeout>30</xa-resource-timeout>
                    </timeout>
                    <statement>
                        <track-statements>False</track-statements>
                        <prepared-statement-cache-size>100</prepared-statement-cache-size>
                        <share-prepared-statements>false</share-prepared-statements>
                    </statement>
                </xa-datasource>
				
                <drivers>
                    <driver name="h2" module="com.h2database.h2">
                        <xa-datasource-class>org.h2.jdbcx.JdbcDataSource</xa-datasource-class>
                    </driver>
                    <driver name="postgresql" module="org.postgresql">
                        <xa-datasource-class>org.postgresql.xa.PGXADataSource</xa-datasource-class>
                    </driver>
                </drivers>
            </datasources>
        </subsystem>

